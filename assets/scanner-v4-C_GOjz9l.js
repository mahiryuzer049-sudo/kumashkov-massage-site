import{g as te,r as ne}from"./index-BYDhyiYq.js";import{b as ae}from"./wa-link-builder-CZFtJDu3.js";import{a as ce}from"./emit-event-D_28Pgnv.js";import{a as ie,g as le,n as oe}from"./runtime-env-BTGPA9v1.js";const k=(e,s,u="unknown")=>{if(typeof e!="string")throw new Error(`[zone-schema] ${u} invalid ${s}`);const m=e.trim();if(!m)throw new Error(`[zone-schema] ${u} empty ${s}`);return m},W=(e,s,u="unknown")=>{if(!e||typeof e!="object"||Array.isArray(e))throw new Error(`[zone-schema] ${u} invalid ${s}`);return e},ue=(e,s)=>{if(!e)return{zone:s};const u=W(e,"analytics",s);return{zone:s,...u}},pe=(e=[])=>{if(!Array.isArray(e))throw new Error("[zone-schema] zones must be an array");const s=new Set,u={},m={};return e.forEach(b=>{const f=W(b,"zone"),p=k(f.id,"id");if(s.has(p))throw new Error(`[zone-schema] duplicate id: ${p}`);s.add(p);const E=k(f.label,"label",p),g=k(f.med,"med",p),n=k(f.copy,"copy",p),a=k(f.ctaTemplate,"ctaTemplate",p),h=k(f.protocol,"protocol",p),w=f.media?W(f.media,"media",p):{},F=w.image?k(w.image,"media.image",p):"";u[p]={title:E,med:g,desc:n,msg:a,image:F,analytics:ue(f.analytics,p)},m[p]=h}),{zoneData:u,protocolMap:m}},{scanner:B}=te(ne()),fe=Array.isArray(B&&B.zones)?B.zones:[],{zoneData:me,protocolMap:de}=pe(fe),he=me,ge=de,ye=e=>typeof window<"u"&&typeof window.requestAnimationFrame=="function"?s=>window.requestAnimationFrame(s):s=>setTimeout(()=>s(e()),16),be=()=>typeof window<"u"&&typeof window.cancelAnimationFrame=="function"?e=>window.cancelAnimationFrame(e):e=>clearTimeout(e),ve=(e={})=>{let s=e.target||null;const u=e.now||(()=>Date.now()),m=e.raf||ye(u),b=e.caf||be();let f=!!e.reducedEffects,p=Number.isFinite(e.msPerChar)?e.msPerChar:20,E=Number.isFinite(e.maxCharsPerFrame)?e.maxCharsPerFrame:6,g=null,n=0,a="",h=0;const w=()=>{g&&(b(g),g=null)};return{start:d=>{if(w(),!s)return;if(a=String(d||""),s.textContent="",f){s.textContent=a;return}const S=a.length;if(!S)return;h=0,n=u();const C=L=>{const A=Math.max(0,L-n);n=L;const $=Math.max(1,Math.min(E,Math.round(A/p)));h=Math.min(S,h+$),s.textContent=a.slice(0,h),h<S&&(g=m(C))};g=m(C)},stop:w,setTarget:d=>{s=d||null},updateOptions:(d={})=>{typeof d.reducedEffects=="boolean"&&(f=d.reducedEffects),Number.isFinite(d.msPerChar)&&(p=d.msPerChar),Number.isFinite(d.maxCharsPerFrame)&&(E=d.maxCharsPerFrame)}}},{win:l,doc:i,nav:x,hist:N,loc:y}=le(),P=te(ne()),T=P&&P.scanner?P.scanner:{},I=e=>l&&typeof l.requestAnimationFrame=="function"?l.requestAnimationFrame(e):setTimeout(()=>e(oe()),16),Ee=e=>{l&&typeof l.cancelAnimationFrame=="function"?l.cancelAnimationFrame(e):clearTimeout(e)},Ae=he,we=ge,ze=T.defaultCtaMessage||"Здравствуйте! Хочу записаться на массаж.",Te=e=>String(e).replace(/\D/g,""),X=e=>String(e||"").trim().toLowerCase(),Le="zone-",ke=()=>{const e=i&&i.body&&i.body.dataset?i.body.dataset.metrika:"",s=Number(e||0);return Number.isFinite(s)?s:0},Y=(e,s={})=>ce(e,s,ke(),{legacyChannel:"scanner-event"}),V=e=>!e||!(e instanceof Element)?"unknown":e.classList.contains("active-point")?"point":e.hasAttribute("data-zone-shortcut")?"shortcut":e.hasAttribute("data-point")?"point":"trigger",Se=e=>{const s=e.match(/\.(jpe?g|png)$/i);if(!s)return`url("${e}")`;const u=s[0],m=e.slice(0,-u.length),b=u.toLowerCase()===".png"?"image/png":"image/jpeg";return`image-set(url("${m}.avif") type("image/avif"), url("${m}.webp") type("image/webp"), url("${e}") type("${b}"))`},H=(e,s)=>{if(!e)return"";if(e.dataset&&e.dataset[s])return e.dataset[s];const u=s.replace(/[A-Z]/g,m=>`-${m.toLowerCase()}`);return typeof e.getAttribute=="function"&&e.getAttribute(`data-${u}`)||""},ee=e=>H(e,"point")||H(e,"zoneShortcut"),Ce=e=>Array.from(e.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')).filter(s=>!s.hasAttribute("disabled")),xe=e=>{const s=e.querySelector("#zone-popup"),u=e.querySelector("#zone-title"),m=e.querySelector("#zone-med"),b=e.querySelector("#zone-desc"),f=e.querySelector("#zone-cta"),p=e.querySelector("#zone-close"),E=e.querySelector("#scanner-container"),g=Array.from(e.querySelectorAll(".active-point")),n=Array.from(e.querySelectorAll("[data-zone-shortcut]"));return!s||!u||!m||!b||!E?null:{popup:s,title:u,med:m,desc:b,cta:f,close:p,container:E,points:g,shortcuts:n}},Oe=(e={})=>{const s=e.root||(i?i.getElementById("scanner")||i.getElementById("scanner-section"):null);if(!s)return null;const u=e.zoneData||Ae,m=e.protocolZoneMap||we,b=typeof e.reducedEffects=="boolean"?e.reducedEffects:ie("(prefers-reduced-motion: reduce)").matches,f=typeof e.hashPrefix=="string"?e.hashPrefix:Le,p=e.syncHash!==!1,E=e.phoneDigits||Te(i&&i.body&&i.body.dataset&&i.body.dataset.phone||"79260899019"),g=e.whatsappLoadingText||T.ctaLoading||P&&P.global&&P.global.whatsappLoadingText||"Переход в чат...",n=xe(s);if(!n)return null;const a={isOpen:!1,activeZone:null,lastTrigger:null,currentMsg:"",hashSnapshot:""};let h=!1;const w=t=>{if(!t||typeof t.focus!="function")return;const o=l&&(l.scrollX||l.pageXOffset)||0,r=l&&(l.scrollY||l.pageYOffset)||0;try{t.focus({preventScroll:!0})}catch{t.focus()}I(()=>{if(!l)return;const c=Math.abs((l.scrollX||0)-o),v=Math.abs((l.scrollY||0)-r);(c>1||v>1)&&l.scrollTo(o,r)}),setTimeout(()=>{if(!l)return;const c=Math.abs((l.scrollX||0)-o),v=Math.abs((l.scrollY||0)-r);(c>1||v>1)&&l.scrollTo(o,r)},120)},F=t=>{if(!t||!t.startsWith("#"))return"";const o=t.slice(1);if(!o.startsWith(f))return"";const r=X(o.slice(f.length));return u[r]?r:""},j=()=>{const t=y&&y.hash?y.hash:"";return t.startsWith(`#${f}`)?"":t},_=t=>{if(!p||!y)return;const o=`${y.pathname}${y.search}`,r=t||"",c=r?`${o}${r}`:o;y.href.endsWith(r)&&r||N&&typeof N.replaceState=="function"&&N.replaceState(null,"",c)},d=t=>{n.points.forEach(o=>{const r=H(o,"point")===t;o.classList.toggle("selected",r),o.setAttribute("aria-pressed",String(r))}),n.shortcuts.forEach(o=>{const r=H(o,"zoneShortcut")===t;o.classList.toggle("is-active",r),o.setAttribute("aria-pressed",String(r))}),n.container.dataset.activeZone=t||""},S=ve({target:n.desc,raf:I,caf:Ee,now:oe,reducedEffects:b}),C=t=>{n.popup.dataset.open=t?"true":"false",n.popup.classList.toggle("open",t),n.popup.setAttribute("aria-hidden",t?"false":"true")},L=(t,o={})=>{const r=X(t),c=u[r];if(!c)return!1;const v=o.trigger||null,Q=!!o.focus,z=!!o.skipHash,q=o.source||V(v);x&&x.vibrate&&x.vibrate(10),a.isOpen=!0,a.activeZone=r,a.lastTrigger=v||(i?i.activeElement:null),a.currentMsg=c.msg||"",z||(a.hashSnapshot=j(),_(`#${f}${r}`)),n.popup.dataset.active=r,n.title.innerText=c.title,n.med.innerText=c.med,S.start(c.desc),c.image?(n.popup.style.setProperty("--zone-image-fallback",`url("${c.image}")`),n.popup.style.setProperty("--zone-image",Se(c.image))):(n.popup.style.removeProperty("--zone-image-fallback"),n.popup.style.removeProperty("--zone-image")),C(!0),d(r),re(),Q&&n.close&&I(()=>{w(n.close)});const Z=m[r];if(Z){const O=i?i.querySelector(`[data-protocol-group="zone"] .protocol-chip[data-value="${Z}"]`):null;O&&O.dispatchEvent(new MouseEvent("click",{bubbles:!1,cancelable:!0}))}return Y("scanner_zone_open",{zone:r,source:q,protocol:Z||""}),!0},A=(t={})=>{if(S.stop(),!a.isOpen)return;const o=a.activeZone;a.isOpen=!1,a.activeZone=null,a.currentMsg="";const r=!!t.skipHash;n.popup.dataset.active="",n.popup.style.removeProperty("--zone-image-fallback"),n.popup.style.removeProperty("--zone-image"),C(!1),d(""),K(),a.lastTrigger&&w(a.lastTrigger),a.lastTrigger=null,r||(_(a.hashSnapshot),a.hashSnapshot=""),Y("scanner_zone_close",{zone:o||"",source:"dismiss"})},$=(t,o,r=!1)=>{const c=X(t);return a.isOpen&&a.activeZone===c?(A(),!1):L(c,{trigger:o,focus:r,source:V(o)})},M=t=>{t.preventDefault(),t.stopPropagation();const o=t.currentTarget;if(!(o instanceof Element))return;const r=ee(o);r&&$(r,o,!1)},D=t=>{if(!(t.key==="Enter"||t.key===" "))return;t.preventDefault(),t.stopPropagation();const r=t.currentTarget;if(!(r instanceof Element))return;const c=ee(r);c&&$(c,r,!0)},R=t=>{if(!a.isOpen)return;const o=t.target;if(n.popup.contains(o))return;const r=o.closest(".active-point,[data-zone-shortcut]");r&&s.contains(r)||A()},U=t=>{if(!a.isOpen)return;if(t.key==="Escape"){t.preventDefault(),A();return}if(t.key!=="Tab"||!n.popup.contains(i?i.activeElement:null))return;const o=Ce(n.popup);if(!o.length)return;const r=o[0],c=o[o.length-1];t.shiftKey&&i&&i.activeElement===r?(t.preventDefault(),c.focus()):!t.shiftKey&&i&&i.activeElement===c&&(t.preventDefault(),r.focus())},re=()=>{h||(i.addEventListener("click",R),i.addEventListener("keydown",U),h=!0)},K=()=>{h&&(i.removeEventListener("click",R),i.removeEventListener("keydown",U),h=!1)},G=()=>{if(!n.cta)return;x&&x.vibrate&&x.vibrate(18);const t=n.cta.innerText;n.cta.innerText=g;const o=u[a.activeZone]||{},r=o.title||o.med||a.activeZone||T.zoneFallbackLabel||"Зона",c=i?i.querySelector('[data-protocol-group="zone"] .protocol-chip.is-active'):null,v=c&&(c.dataset.label||c.textContent)||"",z=[a.currentMsg||o.msg||ze],q=T.zoneLabelPrefix||"Зона",Z=T.protocolLabelPrefix||"Протокол";z.push(`${q}: ${r}.`),v&&z.push(`${Z}: ${v.trim()}.`),z.push(T.intentLine||"Интент: подбор сеанса по зоне."),z.push("",T.sourceLine||"Источник: Scanner: Zone CTA"),z.push(T.utmLine||"utm_source=site&utm_medium=whatsapp&utm_campaign=scanner-zone");const O=z.join(`
`);Y("scanner_cta_click",{zone:a.activeZone||"",protocol:v.trim()}),setTimeout(()=>{const se=ae(E,O);l&&typeof l.open=="function"&&l.open(se,"_blank","noopener,noreferrer"),setTimeout(()=>{n.cta.innerText=t},900)},550)};n.points.forEach(t=>{t.setAttribute("aria-pressed","false"),t.setAttribute("aria-controls","zone-popup"),t.addEventListener("click",M),t.addEventListener("keydown",D)}),n.shortcuts.forEach(t=>{t.setAttribute("aria-pressed","false"),t.setAttribute("aria-controls","zone-popup"),t.addEventListener("click",M),t.addEventListener("keydown",D)}),n.popup.dataset.active="",C(!1),n.close&&n.close.addEventListener("click",A),n.cta&&n.cta.addEventListener("click",G);const J=()=>{if(!p)return;const t=F(y?y.hash:"");if(t){a.activeZone!==t&&L(t,{trigger:null,focus:!1,skipHash:!0,source:"hash"});return}a.isOpen&&A({skipHash:!0})};if(p){l&&l.addEventListener("hashchange",J);const t=F(y?y.hash:"");t&&L(t,{trigger:null,focus:!1,skipHash:!0,source:"hash"})}return{openZone:L,closeZone:A,destroy:()=>{K(),n.points.forEach(t=>{t.removeEventListener("click",M),t.removeEventListener("keydown",D)}),n.shortcuts.forEach(t=>{t.removeEventListener("click",M),t.removeEventListener("keydown",D)}),n.close&&n.close.removeEventListener("click",A),n.cta&&n.cta.removeEventListener("click",G),p&&l&&l.removeEventListener("hashchange",J)},debug:()=>({popup:!!n.popup,title:!!n.title,med:!!n.med,desc:!!n.desc,cta:!!n.cta,points:n.points.length,shortcuts:n.shortcuts.length,popupOpen:!!n.popup.classList.contains("open"),active:n.popup.dataset.active||""})}};export{Oe as initScannerV4};
